name: Build RcloneFlix

on:
  push:
    branches: [main]
  workflow_dispatch: # allows manual trigger from the Actions tab

jobs:
  build-linux:
    runs-on: ubuntu-22.04

    steps:
      # ── 1. Check out the code ──────────────────────────────────────────────
      - name: Checkout
        uses: actions/checkout@v4

      # ── 2. Install Linux system dependencies ──────────────────────────────
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            file \
            libxdo-dev \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            imagemagick \
            libvlc-dev \
            libvlccore-dev \
            vlc-plugin-base \
            libfuse2

      # ── 3. Install rclone into resources folder ────────────────────────────
      - name: Bundle rclone binary
        run: |
          mkdir -p src-tauri/resources
          curl -L https://downloads.rclone.org/rclone-current-linux-amd64.zip -o /tmp/rclone.zip
          unzip /tmp/rclone.zip -d /tmp/rclone-tmp
          cp /tmp/rclone-tmp/rclone-*/rclone src-tauri/resources/rclone
          chmod +x src-tauri/resources/rclone
          echo "rclone version: $(src-tauri/resources/rclone version)"

      # ── 3b. Bundle VLC codec plugins ───────────────────────────────────────
      # linuxdeploy auto-bundles libvlc.so.5 (linked) but NOT the codec plugins
      # (dlopen'd at runtime). We copy them into resources so AppImage works
      # without a system VLC install. VLC_PLUGIN_PATH is set at app startup.
      - name: Bundle VLC plugins
        run: |
          set -euo pipefail
          VLC_PLUGIN_SRC=$(find /usr/lib /usr/lib/x86_64-linux-gnu -maxdepth 4 \
            -type d -name "plugins" 2>/dev/null | grep -i vlc | head -1 || true)
          if [ -z "$VLC_PLUGIN_SRC" ]; then
            echo "::warning::VLC plugin directory not found — AppImage will need system VLC"
            # Create an empty marker so the glob in tauri.conf.json is skipped
            touch src-tauri/resources/.vlc-plugins-missing
          else
            echo "Copying VLC plugins from: $VLC_PLUGIN_SRC"
            mkdir -p src-tauri/resources/vlc/plugins
            cp -r "$VLC_PLUGIN_SRC"/. src-tauri/resources/vlc/plugins/
            COUNT=$(find src-tauri/resources/vlc/plugins -name '*.so' | wc -l)
            echo "Plugin count: $COUNT"
            if [ "$COUNT" -eq 0 ]; then
              echo "::warning::No .so files found after copy — skipping VLC plugin bundling"
              rm -rf src-tauri/resources/vlc
              touch src-tauri/resources/.vlc-plugins-missing
            fi
          fi

      # ── 4. Install Rust ────────────────────────────────────────────────────
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      # ── 5. Cache Rust build artifacts (speeds up future builds a lot) ─────
      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      # ── 6. Install Node.js 20 ──────────────────────────────────────────────
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      

      # ── 7. Install npm dependencies ────────────────────────────────────────
      - name: Install npm dependencies
        run: npm install

      # ── 8. Generate app icons ──────────────────────────────────────────────
      - name: Generate app icons
        run: |
          convert -size 1024x1024 xc:#080A0F \
            -fill '#E8A020' \
            -font DejaVu-Sans-Bold \
            -pointsize 600 \
            -gravity center \
            -annotate 0 'R' \
            /tmp/icon.png
          npx tauri icon /tmp/icon.png

      # ── 9. Add resources back to tauri.conf.json ──────────────────────────
      - name: Patch tauri.conf.json to include bundled resources
        run: |
          node -e "
            const fs = require('fs');
            const conf = JSON.parse(fs.readFileSync('src-tauri/tauri.conf.json', 'utf8'));
            const hasPlugins = !fs.existsSync('src-tauri/resources/.vlc-plugins-missing');
            conf.bundle.resources = hasPlugins
              ? { 'resources/rclone': 'rclone', 'resources/vlc/plugins/**': 'vlc/plugins' }
              : { 'resources/rclone': 'rclone' };
            console.log('Bundling VLC plugins:', hasPlugins);
            fs.writeFileSync('src-tauri/tauri.conf.json', JSON.stringify(conf, null, 2));
          "

      # ── 10. Build the app ──────────────────────────────────────────────────
      - name: Build RcloneFlix
        env:
          # Allows linuxdeploy/appimagetool (AppImages themselves) to run
          # without FUSE by extracting themselves into a temp directory.
          APPIMAGE_EXTRACT_AND_RUN: 1
          VITE_GOOGLE_CLIENT_ID: ${{ secrets.VITE_GOOGLE_CLIENT_ID }}
          VITE_GOOGLE_CLIENT_SECRET: ${{ secrets.VITE_GOOGLE_CLIENT_SECRET }}
        run: npm run tauri build

      # ── 11. Upload .deb as artifact ────────────────────────────────────────
      - name: Upload .deb package
        uses: actions/upload-artifact@v4
        with:
          name: RcloneFlix-linux-deb
          path: src-tauri/target/release/bundle/deb/*.deb
          if-no-files-found: warn

      # ── 12. Upload .AppImage as artifact ──────────────────────────────────
      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: RcloneFlix-linux-AppImage
          path: src-tauri/target/release/bundle/appimage/*.AppImage
          if-no-files-found: warn
