name: Build RcloneFlix

on:
  push:
    branches: [main]
  workflow_dispatch: # allows manual trigger from the Actions tab

jobs:
  build-linux:
    runs-on: ubuntu-22.04

    steps:
      # ── 1. Check out the code ──────────────────────────────────────────────
      - name: Checkout
        uses: actions/checkout@v4

      # ── 2. Install Linux system dependencies ──────────────────────────────
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            file \
            libxdo-dev \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            imagemagick \
            libvlc-dev \
            libvlccore-dev \
            libfuse2

      # ── 3. Install rclone into resources folder ────────────────────────────
      - name: Bundle rclone binary
        run: |
          mkdir -p src-tauri/resources
          curl -L https://downloads.rclone.org/rclone-current-linux-amd64.zip -o /tmp/rclone.zip
          unzip /tmp/rclone.zip -d /tmp/rclone-tmp
          cp /tmp/rclone-tmp/rclone-*/rclone src-tauri/resources/rclone
          chmod +x src-tauri/resources/rclone
          echo "rclone version: $(src-tauri/resources/rclone version)"

      # ── 4. Install Rust ────────────────────────────────────────────────────
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      # ── 5. Cache Rust build artifacts (speeds up future builds a lot) ─────
      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      # ── 6. Install Node.js 20 ──────────────────────────────────────────────
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      

      # ── 7. Install npm dependencies ────────────────────────────────────────
      - name: Install npm dependencies
        run: npm install

      # ── 8. Generate app icons ──────────────────────────────────────────────
      - name: Generate app icons
        run: |
          convert -size 1024x1024 xc:#080A0F \
            -fill '#E8A020' \
            -font DejaVu-Sans-Bold \
            -pointsize 600 \
            -gravity center \
            -annotate 0 'R' \
            /tmp/icon.png
          npx tauri icon /tmp/icon.png

      # ── 9. Add resources back to tauri.conf.json ──────────────────────────
      - name: Patch tauri.conf.json to include rclone resource
        run: |
          node -e "
            const fs = require('fs');
            const conf = JSON.parse(fs.readFileSync('src-tauri/tauri.conf.json', 'utf8'));
            conf.bundle.resources = { 'resources/rclone': 'rclone' };
            fs.writeFileSync('src-tauri/tauri.conf.json', JSON.stringify(conf, null, 2));
          "

      # ── 10. Build the app ──────────────────────────────────────────────────
      - name: Build RcloneFlix
        env:
          # Allows linuxdeploy/appimagetool (AppImages themselves) to run
          # without FUSE by extracting themselves into a temp directory.
          APPIMAGE_EXTRACT_AND_RUN: 1
          VITE_GOOGLE_CLIENT_ID: ${{ secrets.VITE_GOOGLE_CLIENT_ID }}
          VITE_GOOGLE_CLIENT_SECRET: ${{ secrets.VITE_GOOGLE_CLIENT_SECRET }}
        run: npm run tauri build

      # ── 11. Upload .deb as artifact ────────────────────────────────────────
      - name: Upload .deb package
        uses: actions/upload-artifact@v4
        with:
          name: RcloneFlix-linux-deb
          path: src-tauri/target/release/bundle/deb/*.deb
          if-no-files-found: warn

      # ── 12. Upload .AppImage as artifact ──────────────────────────────────
      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: RcloneFlix-linux-AppImage
          path: src-tauri/target/release/bundle/appimage/*.AppImage
          if-no-files-found: warn
