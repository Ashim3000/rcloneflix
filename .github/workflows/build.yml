name: Build RcloneFlix

on:
  push:
    branches: [main]
  workflow_dispatch:

defaults:
  run:
    working-directory: rcloneflix

jobs:
  build-linux:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            file \
            libxdo-dev \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            imagemagick

      - name: Bundle rclone binary
        run: |
          mkdir -p src-tauri/resources
          curl -L https://downloads.rclone.org/rclone-current-linux-amd64.zip -o /tmp/rclone.zip
          unzip /tmp/rclone.zip -d /tmp/rclone-tmp
          cp /tmp/rclone-tmp/rclone-*/rclone src-tauri/resources/rclone
          chmod +x src-tauri/resources/rclone

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: rcloneflix/src-tauri

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install npm dependencies
        run: npm install

      - name: Generate app icons
        run: |
          convert -size 1024x1024 xc:#080A0F \
            -fill '#E8A020' \
            -font DejaVu-Sans-Bold \
            -pointsize 600 \
            -gravity center \
            -annotate 0 'R' \
            /tmp/icon.png
          npx tauri icon /tmp/icon.png

      - name: Patch tauri.conf.json to include rclone resource
        run: |
          node -e "
            const fs = require('fs');
            const conf = JSON.parse(fs.readFileSync('src-tauri/tauri.conf.json', 'utf8'));
            conf.bundle.resources = { 'resources/rclone': 'rclone' };
            fs.writeFileSync('src-tauri/tauri.conf.json', JSON.stringify(conf, null, 2));
          "

      - name: Build RcloneFlix
        run: npm run tauri build

      - name: Upload .deb package
        uses: actions/upload-artifact@v4
        with:
          name: RcloneFlix-linux-deb
          path: rcloneflix/src-tauri/target/release/bundle/deb/*.deb
          if-no-files-found: warn

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: RcloneFlix-linux-AppImage
          path: rcloneflix/src-tauri/target/release/bundle/appimage/*.AppImage
          if-no-files-found: warn
